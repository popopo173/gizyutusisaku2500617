/*
api.ts
役割：OpenAI API とファイル生成APIの通信処理
translateToEnglish(text)：OpenAIで翻訳
generateImages(prompt, n)：画像生成API呼び出し
exportSlides(images)：Flaskサーバー経由でPPTXエクスポート
*/

import OpenAI from "openai";

// APIキー管理
const openai = new OpenAI({
  apiKey: process.env.__(1)__,
  dangerouslyAllowBrowser: __(2)__,
});

// 日本語入力を英語に翻訳
export const translateToEnglish = async (text: string): Promise<string> => {
  try {
    const response = await openai.chat.completions.create({
      model: "__(3)__",
      messages: [
        {
          role: "system",
          content:
            "Translate the following Japanese text into English. Only return the translated English text.",
        },
        { role: "user", content: text },
      ],
    });
    return response.choices[0].message.__(4)__?.trim() || text;
  } catch (err) {
    console.error("Translation error:", err);
    alert("翻訳に失敗しました。");
    return text;
  }
};

// 画像生成APIを実行
export const generateImages = async (
  prompt: string,
  n: number,
  setLoading: (v: boolean) => void
): Promise<string[]> => {
  setLoading(__(5)__);
  try {
    const response = await openai.__(6)__.generate({
      prompt,
      n,
      size: "__(7)__",
      response_format: "__(8)__",
    });
    return response?.data?.map((img) => img.__(9)__ || "") ?? [];
  } catch (err) {
    console.error(err);
    alert("画像生成に失敗しました");
    return [];
  } finally {
    setLoading(__(10)__);
  }
};

// スライド生成
export const exportSlides = async (images: string[]): Promise<void> => {
  try {
    const response = await fetch("__(11)__", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ __(12)__ }),
    });

    if (!response.ok) throw new Error("__(13)__");

    const blob = await response.blob();
    const url = window.URL.__(14)__(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "__(15)__";
    a.click();
    window.URL.__(16)__(url);
  } catch (err) {
    console.error("Export error:", err);
    alert("エクスポートに失敗しました");
  }
};

// Tips生成API（プロンプトに基づく短文アドバイス）
export const generateTips = async (prompt: string): Promise<string> => {
  try {
    const response = await openai.chat.completions.create({
      model: "__(17)__",
      messages: [
        {
          role: "user",
          content: prompt,
        },
      ],
      temperature: __(18)__,
    });

    return response.choices[0].message.content?.__(19)__"() || "";
  } catch (err) {
    console.error("Tips生成エラー:", err);
    return "__(20)__";
  }
};